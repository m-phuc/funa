/**
 * Funa v1.0
 * 
 * https://github.com/m-phuc/funa
 * @license MIT
 */
function e(e){if(!new.target)throw new Error("Funa() must be called with new");const t=this,n=(()=>{let e=[];function t(e){return e.split(/\{\s*((?:`.*`|.)*?)\s*\}/g)}function n(e,t){let n=[],r=[],i=!1,o=e.replace(/`([^`]*)`|(-?\d+(?:\.\d+)?)|([\w\.]+)/g,((e,t,r,i)=>null!=t?"A"+(n.push(t)-1):null!=r?"A"+(n.push(parseFloat(r))-1):null!=i?"I"+(n.push(i)-1):void 0));if(o=o.replace(/\s*(?=\(|\)|,|->)|(?<=\(|\)|,|->)\s*/g,""),o=o.replace(/I(\d+)(?:\(([^)]*)\))?/g,((e,t,o)=>{let l=n[t];if(null!=o){let e=[],t={name:l,args:e};if(o=o.trim())for(let t of o.split(","))if(t){let r=t.match(/^A(\d+)$/);r?e.push(n[r[1]]):i=!0}else e.push(null);return"F"+(r.push(t)-1)}return"T"+(r.push(l)-1)})),!i){let e=t(o,r);if(e)return e}throw"Syntax error: "+e}function r(e){return e.replace(/-./g,(e=>e[1].toUpperCase()))}function i(e,t,n,r,i){return t===n?e:t===r?{name:e,args:5===arguments.length?i:[]}:void 0}function o(e,t){t||(t=r(e.substring(1)));let n=t.split(".");return{bind:"$"===e[0],prop:n[n.length-1],path:n}}function l(e,t){return{name:t}}function f(e,t){return{not:"!"===e,hnd:n(t,((e,t)=>i(t[0],e,"F0","T0",void 0)))}}function a(e,t){return{name:t}}function s(e,t){let o=n(t,((e,t)=>i(t[0],e,"F0","T0")));return{evt:r(e.substring(1)),hnd:o}}function u(e,l){let f=t(l);if(3!==f.length||f[0]||f[2])throw"Syntax error: "+l;return n(f[1],((t,n)=>{let l=t.match(/^(?:(F|T)(\d+)->)?(?:\$T(\d+)(?:\:(F|T)(\d+))?)(?:->(F|T)(\d+))?$/);if(l)return{evt:r(e.substring(1)),src:o("$",n[l[3]]),fmt:l[4]?i(n[l[5]],l[4],"F","T"):void 0,pre:l[1]?i(n[l[2]],l[1],"F","T"):void 0,post:l[6]?i(n[l[7]],l[6],"F","T"):void 0}}))}function c(e){let r=[];return t(e).forEach(((e,t)=>{t%2?"?"===e?r.push({src:o(":","?"),fmt:void 0}):r.push(n(e,((e,t)=>{let n=e.match(/^(\$)?T0(:F1|:T1)?$/);if(n)return{src:o(n[1]||":",t[0]),fmt:i(t[1],n[2],":F1",":T1")}}))):e&&r.push({run:e})})),r}function p(e,t){let n="."===e[0],r=e.indexOf("@");return r>-1?{prop:n,name:e.substring(n?1:0,r),at:u(e.substring(r),t)}:{prop:n,name:n?e.substring(1):e,text:c(t)}}return{set bypass(t){e=t},parseElement:function t(n){if(e.includes(n.tagName))return n;let r={},i=[],u=[];for(let e of Array.from(n.attributes)){let t=e.name[0],n=e.name,u=e.value;":"===t||"$"===t?r.src=o(n,u):"#"===n?r.tpl=l(0,u):"?"===n||"!"===n?r.if=f(n,u):"%"===n?r.is=a(0,u):"@"===t?(r.on||(r.on=[]),r.on.push(s(n,u))):i.push(p(e.name,u))}for(let e of n.childNodes)e instanceof Element?u.push(t(e)):e instanceof Text&&u.push(...c(e.nodeValue));return{tag:n.tagName,bind:r,attr:i,children:u}},parseText:c}})(),r=(()=>{const e=new WeakMap;function t(t,n){let r=e.get(t);if(r){let e=r.get(n);e&&e.forEach((e=>e.call(t)))}}return{notify:t,listen:function(n,r,i){let o=e.get(n);o||(o=new Map,e.set(n,o));let l=o.get(r);l||(l=[],o.set(r,l),function(e,n){let r,i,o;if("object"==typeof e&&(r=Object.getOwnPropertyDescriptor(e,n)),!r||!r.configurable)throw{message:"Target is not observable",object:e,property:n};if(r.hasOwnProperty("value")){let r=e[n];i=()=>r,o=i=>{r=i,t(e,n)}}else i=r.get,r.set&&(o=i=>{r.set.call(e,i),t(e,n)});Object.defineProperty(e,n,{configurable:!0,enumerable:r.enumerable,get:i,set:o})}(n,r)),l.unshift(i)},remove:function(t,n,r){let i=e.get(t);if(!i)return;let o=i.get(n);if(!o)return;let l=o.indexOf(r);l>-1&&o.splice(l,1)}}})(),i=(()=>{const e=new WeakMap;function t(e,t){let n=[],r=[];for(let i=0,o=e.length;i<o;i++){let o=-1;do{o=t.indexOf(e[i],o+1)}while(n.includes(o));n.push(o),o!==i&&r.push({before:o,after:i})}return r}function n(t,n,i){let o=e.get(t);o&&o[n].forEach((e=>e.call(t,i))),"change"!==n&&r.notify(t,"count")}return{observe:function(r){e.has(r)||(e.set(r,{insert:[],remove:[],change:[]}),Object.defineProperties(r,{push:{value:function(...e){let t=r.length,i=Array.prototype.push.apply(r,e);return e.length&&n(r,"insert",{index:t,items:e}),i}},pop:{value:function(){let e=r.length,t=Array.prototype.pop.apply(r);return e&&n(r,"remove",{index:e-1,items:[t]}),t}},unshift:{value:function(...e){let t=Array.prototype.unshift.apply(r,e);return e.length&&n(r,"insert",{index:0,items:e}),t}},shift:{value:function(){let e=r.length,t=Array.prototype.shift.apply(r);return e&&n(r,"remove",{index:0,items:[t]}),t}},reverse:{value:function(){let e=r.slice(),i=Array.prototype.reverse.apply(r),o=t(r,e);return o.length&&n(r,"change",o),i}},sort:{value:function(e){let i=r.slice(),o=Array.prototype.sort.apply(r,[e]),l=t(r,i);return l.length&&n(r,"change",l),o}},splice:{value:function(e,t,...i){let o=r.length;e=e===Number.NEGATIVE_INFINITY?0:e<0?Math.max(o+e,0):Math.min(e,o);let l=arguments.length,f=0===l?[]:1===l?[e]:[e,t,...i],a=Array.prototype.splice.apply(r,f);return a.length&&n(r,"remove",{index:e,items:a}),i.length&&n(r,"insert",{index:e,items:i}),a}},count:{configurable:!0,enumerable:!1,get:()=>r.length}}))},listen:function(t,n,r,i){let o=e.get(t);if(o){let e=[n,r,i];["insert","remove","change"].forEach(((t,n)=>{o[t].push(e[n])}))}},remove:function(t,n,r,i){let o=e.get(t);if(o){let e=[n,r,i];["insert","remove","change"].forEach(((t,n)=>{let r=o[t].indexOf(e[n]);r>-1&&o[t].splice(r,1)}))}}}})();e||(e={}),n.bypass=["TEMPLATE","PRE","CODE",...(e.config?.bypassTags||[]).map((e=>e.toUpperCase()))],["data","as","if","is","on"].forEach((n=>Object.defineProperty(t,n,{value:e[n]||{}})));const o={},l=new WeakMap;function f(e,t){let n=t.name;if(!(n in e))throw new Error("Callback is not defined: "+n);return e[n]}function a(e,t,n){let i=[];return function o(l){let f=l in i,a=l===t.length-1,s=u(e,t.slice(0,l)),c=t[l];f&&r.remove.apply(void 0,i[l]),i[l]=[s,c,a?n:o.bind(void 0,l)],r.listen.apply(void 0,i[l]),a?f&&r.notify(s,c):o(l+1)}(0),function(){i.forEach((e=>r.remove.apply(void 0,e))),i=void 0}}function s(e,t=!1){if(e.nodeType===Node.ELEMENT_NODE)for(let t of e.childNodes)s(t);l.has(e)&&(l.get(e).forEach((e=>e())),l.delete(e)),t&&e.parentElement?.removeChild(e)}function u(e,t){for(let n of t)null!=e&&(e=e[n]);return e}function c(e,n){if(e.run)return e.run;if(e.src){let r="?"===e.src.prop?n:u(n,e.src.path);if(e.fmt){let i=f(t.as,e.fmt);if(!i.convert)throw new Error("Format convert is not defined: "+e.fmt.name);r=i.convert.call(n,r,...e.fmt.args)}return r}}function p(e,n,r){let i,o=e.name,s=e.at,u=s.src;if(u.path.length>1)throw new Error("Nested data binding is not supported: "+u.path.join("."));if(s.fmt&&(i=f(t.as,s.fmt)?.revert,!i))throw new Error("Format revert is not defined: "+s.fmt.name);let p=s.pre?f(t.on,s.pre):void 0,d=s.post?f(t.on,s.post):void 0;function h(){let t=c(s,r);e.prop?n[o]=t:n.setAttribute(o,t)}n.addEventListener(s.evt,(t=>{p&&p.call(r,n,t,...s.pre.args);let l=e.prop?n[o]:n.getAttribute(o);i&&(l=i.call(r,l,...s.fmt.args)),r[u.prop]=l,d&&d.call(r,n,t,...s.post.args)})),h(),l.set(n,[a(r,u.path,h)])}function d(e,t,n){let r=e.name,i=1===e.text.length;function o(){let o=i?c(e.text[0],n):e.text.reduce(((e,t)=>e+(c(t,n)??"")),"");e.prop?t[r]=o:t.setAttribute(r,o??"")}o();for(let r of e.text)r.src&&r.src.bind&&l.set(t,[a(n,r.src.path,o)])}function h(e,n,r,o){let c=r,v=document.createElement(e.tag),b=e.bind,y=[];if(b.src&&(b.src.bind&&y.push(a(c,b.src.path,(function(){let t=h(e,n,c,!1);v.replaceWith(t),s(v,!0)}))),r=u(c,b.src.path)),b.if){let e=b.if.hnd,n=Boolean(e.args?f(t.if,e).call(r,...e.args):u(r,e.name.split(".")));if(b.if.not&&(n=!n),!n)return}if(!b.tpl){for(let t of e.attr)t.at?p(t,v,r):d(t,v,r);if(Array.isArray(r))y.push(function(e,t,n){const r=[];function o(n){let i=n.index<r.length?r[n.index][0]:null;n.items.forEach(((o,l)=>{let f=[];for(let n of e.children){let e=g(n,t,o,!1);e&&(t.insertBefore(e,i),f.push(e))}r.splice(n.index+l,0,f)}))}function l(e){r.splice(e.index,e.items.length).forEach((e=>e.forEach((e=>s(e,!0)))))}function f(e){let n=e.length,i=new Array(n);for(let t=0;t<n;t++)i[t]=r[e[t].before];for(let t=0;t<n;t++)r[e[t].after]=i[t];for(let o=n-1;o>=0;o--){let n=e[o].after+1,l=n<r.length?r[n][0]:null,f=i[o];for(let e=0;e<f.length;e++)t.insertBefore(f[e],l)}}return o({index:0,items:n}),i.observe(n),i.listen(n,o,l,f),function(){i.remove(n,o,l,f),r.splice(0).forEach((e=>e.forEach((e=>s(e,!0)))))}}(e,v,r));else for(let t of e.children)g(t,v,r);if(b.on){let e;for(let n of b.on){let i=f(t.on,n.hnd),o=n.hnd.args;n.evt?v.addEventListener(n.evt,(e=>{i.call(r,v,e,...o)})):e=i.bind(r,v,void 0,...o)}e&&e()}return y.length&&l.set(v,y),o&&n.appendChild(v),v}m(b.tpl.name,n,r)}function g(e,t,n,r=!0){let i;return e instanceof Node?(i=e.cloneNode(!0),r&&t.append(i)):i="tag"in e?h(e,t,n,r):function(e,t,n,r){let i=new Text;function o(){i.nodeValue=c(e,n)??""}return o(),e.src&&e.src.bind&&l.set(i,[a(n,e.src.path,o)]),r&&t.append(i),i}(e,t,n,r),i}function m(e,t,n){for(let r of o[e])g(r,t,n)}function v(e,n){function r(e){let t=n;for(let n of e)if(!(t=t[n]))break;return t}for(let i of e)if("tag"in i){if(i.bind.is)n=f(t.is,i.bind.is);else if(i.bind.src&&n){let e=r(i.bind.src.path);n="object"==typeof e?e:void 0}for(let e of i.attr)if(e.at&&!e.at.fmt&&n){let t=r(e.at.src.path);"string"==typeof t&&(e.at.fmt={name:t,args:[]})}v(i.children,n)}else if("src"in i&&!i.fmt&&n){let e=r(i.src.path);"string"==typeof e&&(i.fmt={name:e,args:[]})}}Object.defineProperties(t,{version:{value:1},render:{value:function(e=document.body,r){e.childNodes.forEach((e=>{if(e instanceof HTMLTemplateElement){if(e.id in o)throw new Error("Duplicated template id: "+e.id);void 0===r&&(r=e.id);let t=[];e.content.childNodes.forEach((e=>{e instanceof Element?t.push(n.parseElement(e)):e instanceof Text&&t.push(...n.parseText(e.nodeValue))})),v(t),o[e.id]=t,e.remove()}})),m(r,e,t.data)}},depend:{value:function(e,t,n,i){arguments.length<4&&(i=n,n=e);let o=r.notify.bind(void 0,e,t);Array.isArray(i)?i.forEach((e=>r.listen(n,e,o))):r.listen(n,i,o)}},define:{value:function(e,t,n){if(n.configurable=!0,Object.defineProperty(e,t,n),n.links){let i=r.notify.bind(void 0,e,t);for(let t of n.links)"string"==typeof t?r.listen(e,t,i):r.listen(t.src,t.prop,i)}}},notify:{value:function(e,t){r.notify(e,t)}}})}export{e as Funa};